---
- name: setup minio directory
  ansible.builtin.file:
    path: /tank/minio
    state: directory
    group: '1000'
    owner: '1000'
    mode: '0600'

- name: run minio
  containers.podman.podman_container:
    name: minio
    image: 'quay.io/minio/minio:RELEASE.2023-01-31T02-24-19Z'
    state: started
    network: host
    command:
      - 'server'
      - '/data'
      - '--console-address'
      - ':9001'
    ports:
      - '9000:9000'
      - '9001:9001'
    env:
      TZ: ${TZ}
      MINIO_ROOT_USER: '{{ minio.root_user }}'
      MINIO_ROOT_PASSWORD: '{{ minio.root_password }}'
      MINIO_UPDATE: 'off'
      MINIO_PROMETHEUS_URL: http://prometheus.{{ external_domain }}
      MINIO_PROMETHEUS_JOB_ID: minio
      MINIO_PROMETHEUS_AUTH_TYPE: 'public'
      MINIO_BROWSER_REDIRECT_URL: 'http://george.{{ internal_domain }}:9001'
      MINIO_SERVER_URL: 'http://george.{{ internal_domain }}:9000'
      MINIO_API_CORS_ALLOW_ORIGIN: https://minio.{{ external_domain}},https://s3.{{ external_domain }}
    volume:
      - '/tank/minio:/data:z'
  become: true

- name: enable podman-systemd | minio
  ansible.builtin.systemd:
    name: ansible-minio
    enabled: true
    scope: user
  environment:
    XDG_RUNTIME_DIR: '/run/user/{{ ansible_user_uid }}'
  become: false
